!function(t){function e(t,e,a,r,i){var n=Math.abs(Math.cos(i)),o=Math.abs(Math.sin(i)),h=t+a/2*Math.cos(i)-r/2*Math.sin(i),c=e+a/2*Math.sin(i)+r/2*Math.cos(i),g=a*n+r*o,s=a*o+r*n;return{cx:h,cy:c,width:g,height:s}}t.module("imgEditor.directives",[]).directive("imgData",[function(){return{restrict:"A",link:function(t,e,a){var r=t.$eval(a.imgData),i=new FileReader;i.onload=function(){t.$apply(function(){var a=new Image;a.onload=function(){e.attr("src",a.src)},a.src=i.result,t.$broadcast("loadedImg",a,a.src)})},i.readAsDataURL(r)}}}]).directive("imgDataFromUri",function(){return{restrict:"A",link:function(t,a,r){var i=document.createElement("canvas"),n=i.getContext("2d"),o=new Image;o.onload=function(){var r=i.width=o.width,h=i.height=o.height;n.drawImage(o,0,0);var c=i.toDataURL("image/jpeg",1),g=new Image;g.src=c;var s=t.model.crop(t);if(s&&s.length>0){var d=new Image;d.src=c;var w=s;w.w=w.x2-w.x,w.h=w.y2-w.y,r=i.width,h=i.height;var m=document.createElement("canvas"),l=m.getContext("2d"),u=document.createElement("canvas"),p=u.getContext("2d"),I=e(w.x,w.y,w.w,w.h,0);m.width=u.width=I.width,m.height=u.height=I.height,l.drawImage(d,I.cx-I.width/2,I.cy-I.height/2,I.width,I.height,0,0,I.width,I.height),p.translate(parseInt(m.width/2),parseInt(m.height/2)),p.drawImage(m,parseInt(-m.width/2),parseInt(-m.height/2));var v=I.width/2-w.w/2,f=I.height/2-w.h/2;i.width=w.w,i.height=w.h,r=i.width,h=i.height,n.drawImage(u,-v,-f),d=m=u=l=p=f=v=null,c=i.toDataURL("image/jpeg",1)}if(t.model.rotation(t)){for(var x=t.model.rotation(t);0>x;)x+=360;var $=x/90%4,y=new Image;y.src=c;for(var M=0;$>M;M++)i.width=h,i.height=r,r=i.width,h=i.height,n.save(),n.translate(r,h/r),n.rotate(Math.PI/2),n.drawImage(y,0,0),n.restore(),y.src=i.toDataURL("image/jpeg",1);y=null,c=i.toDataURL("image/jpeg",1)}t.$broadcast("loadedImg",g,c),a.attr("src",c)},o.crossOrigin="",r.$observe("imgDataFromUri",function(t){o.src=t})}}}).directive("imgThumb",[function(){return{restrict:"A",link:function(t,e,a){t.$on("loadedImg",function(t,a,r){e.attr("src",r)}),t.$on("update",function(t,a){e.attr("src",a)})}}}]).directive("imgEditable",function(t){return{restrict:"A",link:function(a,r,i){function n(){d=null,r.attr("src",m.src),w.src=m.src}function o(){var t=new Image;t.onload=function(){var e,i,n,o=!1,h=document.createElement("canvas"),c=h.getContext("2d");h.width=t.width,h.height=t.height,i=h.width,n=h.height,c.drawImage(t,0,0,t.width,t.height),o||(o=!0,e=new Image,e.src=h.toDataURL("image/jpeg",1),e.onload=function(){h.width=n,h.height=i,i=h.width,n=h.height,c.save(),c.translate(parseInt(i),parseInt(n/i)),c.rotate(Math.PI/2),c.drawImage(e,0,0),c.restore(),e=null,o=!1,r.attr("src",h.toDataURL("image/jpeg",1)),a.$broadcast("update",h.toDataURL("image/jpeg",1)),h=null})},t.src=r.attr("src"),h()}function h(){var t=new Image;t.onload=function(){var e,a,r,i=!1,n=document.createElement("canvas"),o=n.getContext("2d");n.width=t.width,n.height=t.height,a=n.width,r=n.height,o.drawImage(t,0,0,t.width,t.height),i||(i=!0,e=new Image,e.src=n.toDataURL("image/jpeg",1),e.onload=function(){n.width=r,n.height=a,a=n.width,r=n.height,o.save(),o.translate(parseInt(a),parseInt(r/a)),o.rotate(Math.PI/2),o.drawImage(e,0,0),o.restore(),e=null,i=!1;var t=n.toDataURL("image/jpeg",1);n=null,w.src=t})},t.src=w.src}function c(t){var i=new Image;i.src=r.attr("src");var n=document.createElement("canvas"),o=n.getContext("2d"),h=t,c=n.width,g=n.height,s=document.createElement("canvas"),d=s.getContext("2d"),w=document.createElement("canvas"),m=w.getContext("2d"),l=e(h.x,h.y,h.w,h.h,0);s.width=w.width=l.width,s.height=w.height=l.height,d.drawImage(i,l.cx-l.width/2,l.cy-l.height/2,l.width,l.height,0,0,l.width,l.height),m.translate(parseInt(s.width/2),parseInt(s.height/2)),m.drawImage(s,parseInt(-s.width/2),parseInt(-s.height/2));var u=l.width/2-h.w/2,p=l.height/2-h.h/2;n.width=h.w,n.height=h.h,c=n.width,g=n.height,o.drawImage(w,-u,-p),r.attr("src",n.toDataURL("image/jpeg",1)),a.$broadcast("update",n.toDataURL("image/jpeg",1)),i=n=o=c=g=h=d=m=s=w=l=u=p=null}function g(t,e,a,r,i){if(0===i)return{x:t,y:e};if(180===Math.abs(i))return{x:a-t,y:r-e};var n=i*Math.PI/180,o=t-a/2,h=e-r/2,c=r/2,g=a/2;return{x:parseInt(Math.cos(n)*o-Math.sin(n)*h+c),y:parseInt(Math.sin(n)*o+Math.cos(n)*h+g)}}var s,d,w=new Image,m=new Image;a.model={},a.model.crop=t(i.crop),a.model.rotation=t(i.rotation),a.model.trueSize=t(i.trueSize),a.model.base64=t(i.base64),a.$on("loadedImg",function(t,e,r){a.model.base64.assign(a,r)}),a.$on("update",function(t,e){a.model.base64.assign(a,e)}),a.crop||(a.crop=!1),a.rotation||(a.rotation=0),r.attr("src")&&r.attr("src").length>1&&(w.src=r.attr("src")),a.$on("loadedImg",function(t,e,a){w.src=a,m.src=e.src}),a.$on("crop",function(){if(a.cropping=!0,d=new Image,d.src=r.attr("src"),r.attr("src",w.src),console.log([w.width,w.height]),a.crop){var t=g(a.crop.x,a.crop.y,m.width,m.height,a.rotation),e=g(a.crop.x2,a.crop.y2,m.width,m.height,a.rotation),i=[t.x,t.y,e.x,e.y];$(r).Jcrop({trueSize:[w.width,w.height],setSelect:i},function(){s=this})}else $(r).Jcrop({trueSize:[w.width,w.height]},function(){s=this})}),a.$on("reset",function(){a.crop=!1,a.rotation=0,n(),a.$broadcast("update",m.src)}),a.$on("save",function(){if(a.cropping){d=null,a.cropping=!1;var t=s.tellSelect(),e=g(t.x,t.y,w.width,w.height,-a.rotation),i=g(t.x2,t.y2,w.width,w.height,-a.rotation);a.crop={x:e.x,y:e.y,x2:i.x,y2:i.y},a.model.crop.assign(a,a.crop),$(r).css("width",""),$(r).css("height",""),s.destroy(),c(t)}}),a.$on("cancel",function(){a.cropping&&(a.cropping=!1,r.attr("src",d.src),$(r).css("width",""),$(r).css("height",""),d=null,s.destroy())}),a.$on("rotate",function(){a.rotation=(a.rotation+90)%360,a.model.rotation.assign(a,a.rotation),o()})}}})}(angular);