!function(t,e){function a(t,e,a,r,i){var n=Math.abs(Math.cos(i)),o=Math.abs(Math.sin(i)),h=t+a/2*Math.cos(i)-r/2*Math.sin(i),c=e+a/2*Math.sin(i)+r/2*Math.cos(i),s=a*n+r*o,g=a*o+r*n;return{cx:h,cy:c,width:s,height:g}}t.module("imgEditor.directives",[]).directive("imgData",[function(){return{restrict:"A",link:function(t,e,a){var r=t.$eval(a.imgData),i=new FileReader;i.onload=function(){t.$apply(function(){var a=new Image;a.onload=function(){e.attr("src",a.src)},a.src=i.result,t.$broadcast("loadedImg",a,a.src)})},i.readAsDataURL(r)}}}]).directive("imgDataFromUri",function(){return{restrict:"A",link:function(t,e,r){var i=document.createElement("canvas"),n=i.getContext("2d"),o=new Image;o.onload=function(){var r=i.width=o.width,h=i.height=o.height;n.drawImage(o,0,0);var c=i.toDataURL("image/jpeg",1),s=new Image;if(s.src=c,t.model){var g=t.model.crop(t);if(g&&g.length>0){var d=new Image;d.src=c;var w=g;w.w=w.x2-w.x,w.h=w.y2-w.y,r=i.width,h=i.height;var m=document.createElement("canvas"),l=m.getContext("2d"),u=document.createElement("canvas"),p=u.getContext("2d"),I=a(w.x,w.y,w.w,w.h,0);m.width=u.width=I.width,m.height=u.height=I.height,l.drawImage(d,I.cx-I.width/2,I.cy-I.height/2,I.width,I.height,0,0,I.width,I.height),p.translate(parseInt(m.width/2),parseInt(m.height/2)),p.drawImage(m,parseInt(-m.width/2),parseInt(-m.height/2));var f=I.width/2-w.w/2,v=I.height/2-w.h/2;i.width=w.w,i.height=w.h,r=i.width,h=i.height,n.drawImage(u,-f,-v),d=m=u=l=p=v=f=null,c=i.toDataURL("image/jpeg",1)}if(t.model.rotation(t)){for(var x=t.model.rotation(t);0>x;)x+=360;var y=x/90%4,$=new Image;$.src=c;for(var M=0;y>M;M++)i.width=h,i.height=r,r=i.width,h=i.height,n.save(),n.translate(r,h/r),n.rotate(Math.PI/2),n.drawImage($,0,0),n.restore(),$.src=i.toDataURL("image/jpeg",1);$=null,c=i.toDataURL("image/jpeg",1)}}t.$broadcast("loadedImg",s,c),e.attr("src",c)},o.crossOrigin="",r.$observe("imgDataFromUri",function(t){o.src=t})}}}).directive("imgThumb",[function(){return{restrict:"A",link:function(t,e,a){t.$on("loadedImg",function(t,a,r){e.attr("src",r)}),t.$on("update",function(t,a){e.attr("src",a)})}}}]).directive("imgEditable",["$parse",function(t){return{restrict:"A",link:function(r,i,n){function o(){w=null,i.attr("src",l.src),m.src=l.src}function h(){var t=new Image;t.onload=function(){var e,a,n,o=!1,h=document.createElement("canvas"),c=h.getContext("2d");h.width=t.width,h.height=t.height,a=h.width,n=h.height,c.drawImage(t,0,0,t.width,t.height),o||(o=!0,e=new Image,e.src=h.toDataURL("image/jpeg",1),e.onload=function(){h.width=n,h.height=a,a=h.width,n=h.height,c.save(),c.translate(parseInt(a),parseInt(n/a)),c.rotate(Math.PI/2),c.drawImage(e,0,0),c.restore(),e=null,o=!1,i.attr("src",h.toDataURL("image/jpeg",1)),r.$broadcast("update",h.toDataURL("image/jpeg",1)),h=null})},t.src=i.attr("src"),c()}function c(){var t=new Image;t.onload=function(){var e,a,r,i=!1,n=document.createElement("canvas"),o=n.getContext("2d");n.width=t.width,n.height=t.height,a=n.width,r=n.height,o.drawImage(t,0,0,t.width,t.height),i||(i=!0,e=new Image,e.src=n.toDataURL("image/jpeg",1),e.onload=function(){n.width=r,n.height=a,a=n.width,r=n.height,o.save(),o.translate(parseInt(a),parseInt(r/a)),o.rotate(Math.PI/2),o.drawImage(e,0,0),o.restore(),e=null,i=!1;var t=n.toDataURL("image/jpeg",1);n=null,m.src=t})},t.src=m.src}function s(t){var e=new Image;e.src=i.attr("src");var n=document.createElement("canvas"),o=n.getContext("2d"),h=t,c=n.width,s=n.height,g=document.createElement("canvas"),d=g.getContext("2d"),w=document.createElement("canvas"),m=w.getContext("2d"),l=a(h.x,h.y,h.w,h.h,0);g.width=w.width=l.width,g.height=w.height=l.height,d.drawImage(e,l.cx-l.width/2,l.cy-l.height/2,l.width,l.height,0,0,l.width,l.height),m.translate(parseInt(g.width/2),parseInt(g.height/2)),m.drawImage(g,parseInt(-g.width/2),parseInt(-g.height/2));var u=l.width/2-h.w/2,p=l.height/2-h.h/2;n.width=h.w,n.height=h.h,c=n.width,s=n.height,o.drawImage(w,-u,-p),i.attr("src",n.toDataURL("image/jpeg",1)),r.$broadcast("update",n.toDataURL("image/jpeg",1)),e=n=o=c=s=h=d=m=g=w=l=u=p=null}function g(t,e,a,r,i){if(0===i)return{x:t,y:e};if(180===Math.abs(i))return{x:a-t,y:r-e};var n=i*Math.PI/180,o=t-a/2,h=e-r/2,c=r/2,s=a/2;return{x:parseInt(Math.cos(n)*o-Math.sin(n)*h+c),y:parseInt(Math.sin(n)*o+Math.cos(n)*h+s)}}var d,w,m=new Image,l=new Image;r.model={},r.model.crop=t(n.crop),r.model.rotation=t(n.rotation),r.model.trueSize=t(n.trueSize),r.model.base64=t(n.base64),r.$on("loadedImg",function(t,e,a){r.model.base64.assign(r,a)}),r.$on("update",function(t,e){r.model.base64.assign(r,e)}),r.crop||(r.crop=!1),r.rotation||(r.rotation=0),i.attr("src")&&i.attr("src").length>1&&(m.src=i.attr("src")),r.$on("loadedImg",function(t,e,a){m.src=a,l.src=e.src}),r.$on("crop",function(){if(r.cropping=!0,w=new Image,w.src=i.attr("src"),i.attr("src",m.src),console.log([m.width,m.height]),r.crop){var t=g(r.crop.x,r.crop.y,l.width,l.height,r.rotation),a=g(r.crop.x2,r.crop.y2,l.width,l.height,r.rotation),n=[t.x,t.y,a.x,a.y];e(i).Jcrop({trueSize:[m.width,m.height],setSelect:n},function(){d=this})}else e(i).Jcrop({trueSize:[m.width,m.height]},function(){d=this})}),r.$on("reset",function(){r.crop=!1,r.rotation=0,o(),r.$broadcast("update",l.src)}),r.$on("save",function(){if(r.cropping){w=null,r.cropping=!1;var t=d.tellSelect(),a=g(t.x,t.y,m.width,m.height,-r.rotation),n=g(t.x2,t.y2,m.width,m.height,-r.rotation);r.crop={x:a.x,y:a.y,x2:n.x,y2:n.y},r.model.crop.assign(r,r.crop),e(i).css("width",""),e(i).css("height",""),d.destroy(),s(t)}}),r.$on("cancel",function(){r.cropping&&(r.cropping=!1,i.attr("src",w.src),e(i).css("width",""),e(i).css("height",""),w=null,d.destroy())}),r.$on("rotate",function(){r.rotation=(r.rotation+90)%360,r.model.rotation.assign(r,r.rotation),h()})}}}])}(angular,jQuery);